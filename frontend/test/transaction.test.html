<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaction Integration Tests - Credora</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>ðŸ’¸ Transaction Integration Tests</h1>
      <p>Testing transfers, transaction history, and validation</p>
    </div>

    <div class="test-controls">
      <button id="run-tests">Run All Tests</button>
      <button id="clear-results">Clear Results</button>
      
      <div class="config-section">
        <label for="api-url">API URL:</label>
        <input type="text" id="api-url" value="http://localhost:5000/api">
      </div>
      
      <div class="config-section">
        <label for="test-token">Access Token:</label>
        <input type="text" id="test-token" placeholder="Paste your token here">
      </div>
    </div>

    <div id="test-results">
      <p class="loading">Click "Run All Tests" to begin</p>
    </div>
  </div>

  <script src="test-helpers.js"></script>
  <script>
    const runner = new TestRunner();
    let api;
    let testAccounts = [];
    let testTransaction = null;

    // Setup - Get accounts
    async function setupAccounts() {
      const { data } = await api.get('/accounts?fresh=true');
      testAccounts = data.data;
    }

    // Test Suite 1: Create Transaction - Validation
    runner.describe('Transaction Validation', (it) => {
      it('should reject transfer without source account', async () => {
        const { response, data } = await api.post('/transactions', {
          toAccountNumber: '1007654321',
          amount: 50,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject transfer without destination account', async () => {
        await setupAccounts();
        
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          amount: 50,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject transfer without amount', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '1007654321',
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject negative amount', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '1007654321',
          amount: -50,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject zero amount', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '1007654321',
          amount: 0,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject invalid account number', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '123',
          amount: 50,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });
    });

    // Test Suite 2: Create Transaction - Business Logic
    runner.describe('Transaction Business Logic', (it) => {
      it('should reject transfer to non-existent account', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '9999999999',
          amount: 10,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
        expect(data.message).toContain('not found');
      });

      it('should reject transfer to same account', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: testAccounts[0]?.account_number,
          amount: 10,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
        expect(data.message).toContain('same account');
      });

      it('should reject transfer with insufficient balance', async () => {
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '1007654321',
          amount: 999999999,
          description: 'Test transfer'
        });
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
        expect(data.message).toContain('Insufficient');
      });

      it('should successfully transfer valid amount', async () => {
        // Find a valid destination account (you may need to create one)
        const { response, data } = await api.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '1007654321', // Change to valid account
          amount: 10,
          description: 'Integration test transfer'
        });
        
        if (response.status === 201) {
          testTransaction = data.data;
          expect(data.success).toBeTruthy();
          expect(testTransaction).toHaveProperty('referenceNumber');
          expect(testTransaction).toHaveProperty('amount');
          expect(testTransaction).toHaveProperty('balanceAfter');
        }
      });

      it('should update sender balance after transfer', async () => {
        if (testTransaction) {
          const { response, data } = await api.get(`/accounts/${testAccounts[0].id}/balance`);
          
          const newBalance = parseFloat(data.data.balance);
          const oldBalance = parseFloat(testAccounts[0].balance);
          
          expect(newBalance).toBe(testTransaction.balanceAfter);
        }
      });
    });

    // Test Suite 3: Get Transaction History
    runner.describe('Transaction History', (it) => {
      it('should retrieve transaction history', async () => {
        const { response, data } = await api.get('/transactions');
        
        expect(response.status).toBe(200);
        expect(data.success).toBeTruthy();
        expect(Array.isArray(data.data)).toBeTruthy();
      });

      it('should return transaction details', async () => {
        const { response, data } = await api.get('/transactions');
        
        if (data.data.length > 0) {
          const txn = data.data[0];
          expect(txn).toHaveProperty('id');
          expect(txn).toHaveProperty('transaction_type');
          expect(txn).toHaveProperty('amount');
          expect(txn).toHaveProperty('status');
          expect(txn).toHaveProperty('reference_number');
          expect(txn).toHaveProperty('created_at');
        }
      });

      it('should support pagination with limit', async () => {
        const { response, data } = await api.get('/transactions?limit=5');
        
        expect(data.data.length).toBeGreaterThan(0);
      });

      it('should support pagination with offset', async () => {
        const { response, data } = await api.get('/transactions?limit=5&offset=0');
        
        expect(response.status).toBe(200);
        expect(Array.isArray(data.data)).toBeTruthy();
      });

      it('should filter by transaction type', async () => {
        const { response, data } = await api.get('/transactions?type=transfer');
        
        if (data.data.length > 0) {
          data.data.forEach(txn => {
            expect(txn.transaction_type).toBe('transfer');
          });
        }
      });

      it('should filter by account', async () => {
        const accountId = testAccounts[0]?.id;
        const { response, data } = await api.get(`/transactions?accountId=${accountId}`);
        
        expect(response.status).toBe(200);
      });

      it('should sort by date descending', async () => {
        const { response, data } = await api.get('/transactions?limit=10');
        
        if (data.data.length > 1) {
          const dates = data.data.map(txn => new Date(txn.created_at).getTime());
          
          for (let i = 1; i < dates.length; i++) {
            expect(dates[i-1]).toBeGreaterThan(dates[i]);
          }
        }
      });
    });

    // Test Suite 4: Get Transaction Details
    runner.describe('Transaction Details', (it) => {
      let transactionId;

      it('should get specific transaction by ID', async () => {
        const { data: historyData } = await api.get('/transactions?limit=1');
        
        if (historyData.data.length > 0) {
          transactionId = historyData.data[0].id;
          const { response, data } = await api.get(`/transactions/${transactionId}`);
          
          expect(response.status).toBe(200);
          expect(data.success).toBeTruthy();
          expect(data.data.id).toBe(transactionId);
        }
      });

      it('should include account details', async () => {
        if (transactionId) {
          const { response, data } = await api.get(`/transactions/${transactionId}`);
          
          expect(data.data).toHaveProperty('from_account_number');
          expect(data.data).toHaveProperty('to_account_number');
        }
      });

      it('should reject invalid transaction ID', async () => {
        const { response, data } = await api.get('/transactions/invalid-id');
        
        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject non-existent transaction', async () => {
        const fakeUUID = '00000000-0000-0000-0000-000000000000';
        const { response, data } = await api.get(`/transactions/${fakeUUID}`);
        
        expect(response.status).toBe(404);
        expect(data.success).toBeFalsy();
      });
    });

    // Test Suite 5: Transaction Status
    runner.describe('Transaction Status', (it) => {
      it('should have valid status values', async () => {
        const { response, data } = await api.get('/transactions');
        
        const validStatuses = ['pending', 'completed', 'failed', 'reversed'];
        
        data.data.forEach(txn => {
          expect(validStatuses).toContain(txn.status);
        });
      });

      it('should complete transfers immediately', async () => {
        // Most transfers should be completed instantly
        const { response, data } = await api.get('/transactions?type=transfer&limit=5');
        
        if (data.data.length > 0) {
          const completedCount = data.data.filter(txn => txn.status === 'completed').length;
          expect(completedCount).toBeGreaterThan(0);
        }
      });
    });

    // Test Suite 6: Rate Limiting
    runner.describe('Transaction Rate Limiting', (it) => {
      it('should enforce transaction rate limits', async () => {
        const results = [];
        
        // Try 11 transactions rapidly (limit is 10/minute)
        for (let i = 0; i < 11; i++) {
          const { response } = await api.post('/transactions', {
            fromAccountId: testAccounts[0]?.id,
            toAccountNumber: '1007654321',
            amount: 1,
            description: 'Rate limit test'
          });
          results.push(response.status);
        }
        
        // At least one should be rate limited (429)
        const rateLimited = results.filter(status => status === 429);
        expect(rateLimited.length).toBeGreaterThan(0);
      });
    });

    // Test Suite 7: Transaction Security
    runner.describe('Transaction Security', (it) => {
      it('should require authentication', async () => {
        const noAuthAPI = new APIHelper(api.baseURL);
        const { response, data } = await noAuthAPI.post('/transactions', {
          fromAccountId: testAccounts[0]?.id,
          toAccountNumber: '1007654321',
          amount: 10
        });
        
        expect(response.status).toBe(401);
        expect(data.success).toBeFalsy();
      });

      it('should only allow user own accounts', async () => {
        // Try to use account not owned by user
        const fakeUUID = '00000000-0000-0000-0000-000000000000';
        const { response, data } = await api.post('/transactions', {
          fromAccountId: fakeUUID,
          toAccountNumber: '1007654321',
          amount: 10
        });
        
        expect(response.status).toBeGreaterThan(0);
        expect(data.success).toBeFalsy();
      });

      it('should generate unique reference numbers', async () => {
        const { data } = await api.get('/transactions?limit=10');
        
        const references = data.data.map(txn => txn.reference_number);
        const uniqueRefs = new Set(references);
        
        expect(uniqueRefs.size).toBe(references.length);
      });
    });

    // Event Listeners
    document.getElementById('run-tests').addEventListener('click', async () => {
      const apiUrl = document.getElementById('api-url').value;
      const token = document.getElementById('test-token').value;
      
      if (!token) {
        alert('Please provide an access token first!');
        return;
      }
      
      api = new APIHelper(apiUrl);
      api.setToken(token);
      
      document.getElementById('run-tests').disabled = true;
      await runner.run();
      document.getElementById('run-tests').disabled = false;
    });

    document.getElementById('clear-results').addEventListener('click', () => {
      document.getElementById('test-results').innerHTML = '<p class="loading">Click "Run All Tests" to begin</p>';
    });
  </script>
</body>
</html>