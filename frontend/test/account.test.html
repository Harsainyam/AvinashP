<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Integration Tests - Credora</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="test-container">
    <div class="test-header">
      <h1>üè¶ Account Integration Tests</h1>
      <p>Testing account management and balance operations</p>
    </div>

    <div class="test-controls">
      <button id="run-tests">Run All Tests</button>
      <button id="clear-results">Clear Results</button>

      <div class="config-section">
        <label for="api-url">API URL:</label>
        <input type="text" id="api-url" value="http://localhost:5000/api">
      </div>

      <div class="config-section">
        <label for="test-token">Access Token:</label>
        <input type="text" id="test-token" placeholder="Paste token from auth test">
        <button id="load-token"
          style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Load Saved Token
        </button>
      </div>
    </div>

    <div id="test-results">
      <p class="loading">Click "Run All Tests" to begin</p>
    </div>
  </div>

  <script src="test-helpers.js"></script>
  <script>
    const runner = new TestRunner();
    let api;
    let testAccounts = [];

    // Test Suite 1: Get User Accounts
    runner.describe('Get User Accounts', (it) => {
      it('should retrieve user accounts', async () => {
        const { response, data } = await api.get('/accounts');

        console.log('Get accounts response:', { status: response.status, data });

        expect(response.status).toBe(200);
        expect(data.success).toBeTruthy();
        expect(Array.isArray(data.data)).toBeTruthy();

        testAccounts = data.data;
        TestStorage.set('testAccounts', testAccounts);

        // Display accounts info
        if (testAccounts.length > 0) {
          console.log('Test Accounts:', testAccounts);
        }
      });

      it('should return account details', async () => {
        const { response, data } = await api.get('/accounts');

        expect(data.data.length).toBeGreaterThan(0);

        const account = data.data[0];
        expect(account).toHaveProperty('id');
        expect(account).toHaveProperty('account_number');
        expect(account).toHaveProperty('account_type');
        expect(account).toHaveProperty('balance');
        expect(account).toHaveProperty('currency');
        expect(account).toHaveProperty('status');
      });

      it('should only show active accounts', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          expect(account.status).toBe('active');
        });
      });

      it('should use cache for repeated requests', async () => {
        // First request (should hit DB)
        const { data: data1 } = await api.get('/accounts');

        // Second request (should hit cache)
        const { data: data2 } = await api.get('/accounts');

        if (data2.cached !== undefined) {
          expect(data2.cached).toBeTruthy();
        } else {
          console.warn('Cache flag not present in response');
        }
      });

      it('should bypass cache with fresh parameter', async () => {
        const { response, data } = await api.get('/accounts?fresh=true');

        expect(response.status).toBe(200);
        expect(data.cached).toBeFalsy();
      });

      it('should return accounts sorted by creation date', async () => {
        const { response, data } = await api.get('/accounts');

        if (data.data.length > 1) {
          const dates = data.data.map(acc => new Date(acc.created_at).getTime());

          // Check if sorted descending (newest first)
          for (let i = 1; i < dates.length; i++) {
            expect(dates[i - 1]).toBeGreaterThan(dates[i]);
          }
        }
      });
    });

    // Test Suite 2: Get Specific Account
    runner.describe('Get Account Details', (it) => {
      let accountId;

      it('should get specific account by ID', async () => {
        const accounts = TestStorage.get('testAccounts') || testAccounts;
        expect(accounts.length).toBeGreaterThan(0);

        accountId = accounts[0].id;
        const { response, data } = await api.get(`/accounts/${accountId}`);

        console.log('Get account details:', { status: response.status, data });

        expect(response.status).toBe(200);
        expect(data.success).toBeTruthy();
        expect(data.data.id).toBe(accountId);
      });

      it('should include user information', async () => {
        const accounts = TestStorage.get('testAccounts') || testAccounts;
        accountId = accounts[0].id;
        const { response, data } = await api.get(`/accounts/${accountId}`);

        expect(data.data).toHaveProperty('first_name');
        expect(data.data).toHaveProperty('last_name');
        expect(data.data).toHaveProperty('email');
      });

      it('should reject invalid account ID', async () => {
        const { response, data } = await api.get('/accounts/invalid-uuid');

        expect(response.status).toBe(400);
        expect(data.success).toBeFalsy();
      });

      it('should reject non-existent account', async () => {
        const fakeUUID = '00000000-0000-0000-0000-000000000000';
        const { response, data } = await api.get(`/accounts/${fakeUUID}`);

        expect(response.status).toBe(404);
        expect(data.success).toBeFalsy();
      });

      it('should not allow access to other user accounts', async () => {
        // Try to access an account that doesn't belong to the user
        const fakeUUID = '12345678-1234-1234-1234-123456789012';
        const { response, data } = await api.get(`/accounts/${fakeUUID}`);

        // Should return 404 (not found) or 403 (forbidden)
        expect([403, 404]).toContain(response.status);
        expect(data.success).toBeFalsy();
      });
    });

    // Test Suite 3: Get Account Balance
    runner.describe('Get Account Balance', (it) => {
      let accountId;

      it('should get account balance', async () => {
        const accounts = TestStorage.get('testAccounts') || testAccounts;
        accountId = accounts[0].id;
        const { response, data } = await api.get(`/accounts/${accountId}/balance`);

        console.log('Get balance:', { status: response.status, data });

        expect(response.status).toBe(200);
        expect(data.success).toBeTruthy();
        expect(data.data).toHaveProperty('balance');
        expect(data.data).toHaveProperty('currency');
        expect(data.data).toHaveProperty('account_number');
      });

      it('should return numeric balance', async () => {
        const accounts = TestStorage.get('testAccounts') || testAccounts;
        accountId = accounts[0].id;
        const { response, data } = await api.get(`/accounts/${accountId}/balance`);

        const balance = parseFloat(data.data.balance);
        expect(typeof balance).toBe('number');
        expect(isNaN(balance)).toBeFalsy();
        expect(balance).toBeGreaterThan(0);
      });

      it('should reject invalid account for balance', async () => {
        const fakeUUID = '00000000-0000-0000-0000-000000000000';
        const { response, data } = await api.get(`/accounts/${fakeUUID}/balance`);

        expect(response.status).toBe(404);
        expect(data.success).toBeFalsy();
      });

      it('should format balance with proper decimals', async () => {
        const accounts = TestStorage.get('testAccounts') || testAccounts;
        accountId = accounts[0].id;
        const { response, data } = await api.get(`/accounts/${accountId}/balance`);

        const balanceStr = data.data.balance.toString();
        // Should have at most 2 decimal places
        const parts = balanceStr.split('.');
        if (parts.length > 1) {
          expect(parts[1].length).toBeLessThan(3);
        }
      });
    });

    // Test Suite 4: Account Types
    runner.describe('Account Types', (it) => {
      it('should support different account types', async () => {
        const { response, data } = await api.get('/accounts');

        const accountTypes = data.data.map(acc => acc.account_type);
        const validTypes = ['savings', 'checking', 'business'];

        accountTypes.forEach(type => {
          expect(validTypes).toContain(type);
        });
      });

      it('should have at least one account', async () => {
        const { response, data } = await api.get('/accounts');

        expect(data.data.length).toBeGreaterThan(0);
      });

      it('should return account type in lowercase', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          expect(account.account_type).toBe(account.account_type.toLowerCase());
        });
      });

      it('should have default account created on signup', async () => {
        const { response, data } = await api.get('/accounts');

        // At least one account should exist (created during signup)
        expect(data.data.length).toBeGreaterThan(0);

        // Check if first account is a savings account (default)
        const firstAccount = data.data[0];
        expect(['savings', 'checking']).toContain(firstAccount.account_type);
      });
    });

    // Test Suite 5: Account Security
    runner.describe('Account Security', (it) => {
      it('should require authentication', async () => {
        const noAuthAPI = new APIHelper(api.baseURL);
        const { response, data } = await noAuthAPI.get('/accounts');

        expect(response.status).toBe(401);
        expect(data.success).toBeFalsy();
      });

      it('should validate token format', async () => {
        const invalidAPI = new APIHelper(api.baseURL);
        invalidAPI.setToken('invalid-token');

        const { response, data } = await invalidAPI.get('/accounts');

        expect(response.status).toBe(401);
        expect(data.success).toBeFalsy();
      });

      it('should not expose sensitive data', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          expect(account).not.toHaveProperty('password_hash');
          expect(account).not.toHaveProperty('password');
          expect(account).not.toHaveProperty('pin');
        });
      });

      it('should reject expired tokens', async () => {
        const expiredAPI = new APIHelper(api.baseURL);
        // Using a clearly expired/invalid token
        expiredAPI.setToken('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c');

        const { response, data } = await expiredAPI.get('/accounts');

        expect(response.status).toBe(401);
        expect(data.success).toBeFalsy();
      });
    });

    // Test Suite 6: Data Validation
    runner.describe('Data Validation', (it) => {
      it('should have valid account numbers', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          expect(account.account_number.length).toBeGreaterThan(9);
          expect(/^\d+$/.test(account.account_number)).toBeTruthy();
        });
      });

      it('should have valid currency codes', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          expect(account.currency).toBe('USD');
          expect(account.currency.length).toBe(3);
        });
      });

      it('should have non-negative balances', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          const balance = parseFloat(account.balance);
          expect(balance).toBeGreaterThan(0);
        });
      });

      it('should have valid timestamps', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          const createdAt = new Date(account.created_at);
          expect(createdAt instanceof Date).toBeTruthy();
          expect(isNaN(createdAt.getTime())).toBeFalsy();

          // Should be in the past
          expect(createdAt.getTime()).toBeLessThan(Date.now());
        });
      });

      it('should have unique account numbers', async () => {
        const { response, data } = await api.get('/accounts');

        const accountNumbers = data.data.map(acc => acc.account_number);
        const uniqueNumbers = new Set(accountNumbers);

        expect(uniqueNumbers.size).toBe(accountNumbers.length);
      });

      it('should have valid UUID format for account IDs', async () => {
        const { response, data } = await api.get('/accounts');

        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

        data.data.forEach(account => {
          expect(uuidRegex.test(account.id)).toBeTruthy();
        });
      });
    });

    // Test Suite 7: Account Status
    runner.describe('Account Status', (it) => {
      it('should have valid status values', async () => {
        const { response, data } = await api.get('/accounts');

        const validStatuses = ['active', 'frozen', 'closed'];

        data.data.forEach(account => {
          expect(validStatuses).toContain(account.status);
        });
      });

      it('should exclude closed accounts from default query', async () => {
        const { response, data } = await api.get('/accounts');

        data.data.forEach(account => {
          expect(account.status).not.toBe('closed');
        });
      });

      it('should have mostly active accounts', async () => {
        const { response, data } = await api.get('/accounts');

        const activeCount = data.data.filter(acc => acc.status === 'active').length;
        expect(activeCount).toBeGreaterThan(0);
      });
    });

    // Load saved token button handler
    document.getElementById('load-token').addEventListener('click', () => {
      const savedToken = TestStorage.get('accessToken');

      console.log('Attempting to load token...');
      console.log('Token found:', savedToken ? 'Yes' : 'No');

      if (savedToken) {
        document.getElementById('test-token').value = savedToken;

        // Show success message with token preview
        const tokenPreview = savedToken.substring(0, 20) + '...';
        alert(`‚úÖ Token loaded successfully!\n\nPreview: ${tokenPreview}\n\nYou can now run the tests.`);
      } else {
        // Check if any test data exists
        const allKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('credora_test_')) {
            allKeys.push(key);
          }
        }

        if (allKeys.length > 0) {
          alert(`‚ö†Ô∏è Found ${allKeys.length} test data items, but no access token.\n\nAvailable data: ${allKeys.join(', ')}\n\nPlease run the Authentication tests first to generate a token.`);
        } else {
          alert('‚ùå No saved token found.\n\nPlease run the Authentication tests first:\n1. Go back to test-runner.html\n2. Click "Run Auth Tests"\n3. Complete the OTP verification\n4. Copy the token\n5. Return here and click "Load Saved Token"');
        }
      }
    });

    // Event Listeners
    document.getElementById('run-tests').addEventListener('click', async () => {
      const apiUrl = document.getElementById('api-url').value;
      const token = document.getElementById('test-token').value;

      if (!token) {
        alert('Please provide an access token first! Run the Auth tests to get one or click "Load Saved Token".');
        return;
      }

      api = new APIHelper(apiUrl);
      api.setToken(token);

      document.getElementById('run-tests').disabled = true;
      document.getElementById('test-results').innerHTML = '<h2>Running Tests...</h2>';

      try {
        await runner.run();
      } catch (error) {
        console.error('Test runner error:', error);
        alert('Test run failed: ' + error.message);
      } finally {
        document.getElementById('run-tests').disabled = false;
      }
    });

    document.getElementById('clear-results').addEventListener('click', () => {
      document.getElementById('test-results').innerHTML = '<p class="loading">Click "Run All Tests" to begin</p>';
      runner.results = { passed: 0, failed: 0, total: 0 };
    });

    // Auto-load token on page load
    window.addEventListener('load', () => {
      console.log('Page loaded, checking for saved token...');

      const savedToken = TestStorage.get('accessToken');

      if (savedToken) {
        document.getElementById('test-token').value = savedToken;
        console.log('‚úÖ Auto-loaded saved token');

        // Show a subtle notification
        const notification = document.createElement('div');
        notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #d1fae5;
      border: 2px solid #10b981;
      color: #065f46;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    `;
        notification.innerHTML = '‚úÖ Token auto-loaded from storage';
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      } else {
        console.log('‚ùå No saved token found');
      }
    });
  </script>
</body>

</html>